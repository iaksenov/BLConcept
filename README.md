# Концепт слоя бизнес логики и слоя представления для кассы

### Краткое описание

  Реализация соответствует паттерну MVC.  
  Роль контроллера выполняет понятие "сценарий".
  
#### Сценарий
    
  Сценарии могут быть разных типов, с аргументом и без, с результатом и без.      
  Базовый интерфейс см. ru.crystals.pos.bl.api.scenarios.Scenario.  
  
  Жизненный цикл может быть как singleton так и stateless класс.
  Экземпляр сценария может быть создан как в SpringContext, так и явным образом через конструктор.
  
  Сценарий это по сути контроллер, который:
   - обрабатывает события от действий пользователя
   - управляет слоем представления
   - вызывает методы модулей из инфраструктурного слоя, обрабатывает их события
   
  Управление сценариями (их запуском) выполняется только через менеджер ru.crystals.pos.bl.ScenarioManager,
  который в аргументе метода start передает сценарию интерфейс ru.crystals.pos.ui.UI для взаимодействия со слоем представления.
  
  Активных сценариев может быть несколько, т.к. сценарий может запустить дочерний сценарий.  
  Таким образом выстраивается цепочка:  
  Сц1 -> Сц2 -> Сц3 -> Сц4 -> Сц5
  
#### Обработка событий  
  
  События обрабатываются в последовательности: 5, 4, 3, 2, 1  
  Если сценарий реализует соответствующий интерфейс слушателя события, событие будет передано только ему.  
  Есть также возможность обрабатывать и управлять пересылкой событий следующему сценарию реализовав интерфейс
  ru.crystals.pos.bl.api.scenarios.special.ScenarioEventProcessor    
  Интерфейс-маркер ru.crystals.pos.bl.api.scenarios.special.IgnoreAllEvents предназначен для игнорирования обработки всех событий на время его, сценария, активности.  
  
  Все события от действий человека имеют базовый тип ru.crystals.pos.hw.events.HumanEvent  
  
  Иерархия классов событий:
```  
 HumanEvent (базовый интерфейс)
   +- HWHumanEvent (hardware события)
   |   +- HWBLHumanEvent (события для обработки сценариями)
   |   |   +- FuncKey    (функцианльные кнопки: ПОДИТОГ, ОПЛАТА БАНКОМ, ОТКРЫТЬ Д.Я. и пр.) 
   |   |   +- Barcode    (штрихкод от сканера)
   |   |   +- MSRTracks  (дорожки от считываетля магнитных карт)
   |   +- HWUIHumanEvent (события для обработки представлением)
   |   |   +- TypedKey   (печатаемые кнопки)
   |   |   +- ControlKey (кнопки управления: Enter, Esc, Backspace, Стрелки и т.д.)
   +- UIHumanEvent       (UI события)
```
  
  Сценарии обрабатывают только HWBLHumanEvent события и callback от UI (UIHumanEvent).
  Остальные события обрабатывает GUI.
  
  Все события поступают в одну очередь и уже из неё последовательно отправляются в соответствующий архитектурный слой.
  см. ru.crystals.pos.bl.events.HumanEventListener  
   
#### Взаимодействие с UI
  Подробно про UI тут: https://docs.google.com/document/d/1t9G4VW-94zHCr-7Km5a6D8yNuRZu9_6HMC_TQLMDhYk/edit?usp=sharing

  В UI есть два основных понятия: слой и форма.  
  Слой это полноэкранный режим/состояние визуализации кассы см. ru.crystals.pos.ui.UILayer  
  Может быть только один активный слой, их можно переключать.
  Смена слоя выполняется методом ru.crystals.pos.bl.ScenarioManager.setLayer
  Каждому слою UI привязан соответствующий сценарий ru.crystals.pos.bl.api.layer.LayerScenario  
  При активации слоя именно этому сценарию передается управление.  
  Цепочка сценариев запоминается для каждого слоя. Реализация UI также помнит состояние форм для каждого слоя.  
  
##### Ограничения:
  - Взаимодействие с UI должно выполняться только с объектом переданным в аргументе метода start сценария.
  - Только последний в цепочке вызванных сценариев может показывать UI формы 
  
##### Статус кассы
  Статус кассы передается событием ru.crystals.pos.ui.events.POSStatusEvent
  
##### Context
  Реализация UI выполнена в отдельном package, запускается спрингом первой в отдельном контексте.  
     
#### Demo
  Проект собирается gradle-плагином application
  Запуск проекта:
```bash
gradle -p sl/loader run
```
  Сборка дистрибутива:
```bash
gradle -p sl/loader distTar
```
  Возможности перечислены на экране логина.
